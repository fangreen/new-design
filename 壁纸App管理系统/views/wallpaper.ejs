
<!DOCTYPE>
<html>
<head>
    <title> formdata file jquery ajax upload</title>
</head>
<body>
    <div class="pic_right">
<form role="form" id="myForm"  method="post" enctype="multipart/form-data" class="pic_add">
    <div><h3>新增壁纸</h3></div>
    <div class="form-group">
        <div class="pic_box"><span>+</span>
            <div class="thumb-img-box" id="thumb-box"></div>
            <input type="file" name="fulAvatar" id="file_upload" value="" class="picture" placeholder="图片地址" onchange="upImg()">
        </div>
        <label for="url" class="pic_xuanze">图片选择</label>
    </div>
    <div class="pic_classify">
        <select class="fenlei">
            <option class="girl">美女</option>
            <option class="animation">动漫</option>
            <option class="landscape">风景</option>
            <option class="game">游戏</option>
            <option class="text">文字</option>
            <option class="vision">视觉</option>
            <option class="emotion">情感</option>
            <option class="creative">设计</option>
            <option class="celebrity">明星</option>
            <option class="stuff">物语</option>
            <option class="art">艺术</option>
            <option class="man">男人</option>
            <option class="cartoon">卡通</option>
            <option class="machine">机械</option>
            <option class="cityscape">城市</option>
            <option class="animal">动物</option>
            <option class="sport">运动</option>
            <option class="movie">影视</option>
        </select>
    </div>
    <div class="pic_biaoqian"><input type="text" placeholder="添加标签"></div>
    <div ></div>
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-7">
           <input type="button" onclick="selectImg()" value="上传">
        </div>
    </div>
</form>
<div class="pic_all"></div>
</div>
 <script>
     $(function(){
         var str="";
         $.ajax({
             url:"/users/pic_all",
             type:"post",
             success:function(data){
                 $.each(data,function(i){
                     str+="<img src="+ data[i].url+">";
                 })
                 $(".pic_all").html(str);
             }
         })
     })
 </script>
<script type="text/javascript">
        function upImg(){
            var fileInput=document.getElementById("file_upload");//文件选择按钮
            var imgDivs=document.getElementById("thumb-box");//图片容器
                if(window.FileReader){//支持FileReader的时候
                    var reader=new FileReader();
                    reader.readAsDataURL(fileInput.files[0]);
                    reader.onload=function(evt){
                        imgDivs.innerHTML="<img src="+evt.target.result+"\>";
                    }
                }else{//兼容ie9-
                    imgDivs.innerHTML='<div class="img" style="filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale,src=\'' + fileInput.value + '\)\';"></div>';
                }
            }
        function selectImg(fileInputs){
            var fileInputs = document.getElementById("file_upload");
            var checkImg=new RegExp("(.jpg$)|(.png$)|(.bmp$)|(.jpeg$)","i");
                 if(checkImg.test(fileInputs.value)){
                     uploadByForm();
                }else{
                      alert("只支持上传.jpg .png .bmp .jpeg;你的选择有误");
                 }

        }

    /**
     * ajax 上传。
     */
    function uploadByForm() {
        //用form 表单直接 构造formData 对象; 就不需要下面的append 方法来为表单进行赋值了。
        var formData = new FormData($("#myForm")[0]);
        var url = "/users/uploader";
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,

            /**
             * 必须false才会避开jQuery对 formdata 的默认处理
             * XMLHttpRequest会对 formdata 进行正确的处理
             */
            processData: false,
            /**
             *必须false才会自动加上正确的Content-Type
             */
            contentType: false,
            success: function (responseStr) {
                // alert(responseStr.newPath);
                console.log(responseStr.newPath);
                // $("img").attr({"src": responseStr.newPath}).prependTo($("body"));
                window.location.href="wallpaper";
            },
            error: function (responseStr) {
                alert(responseStr.newPath);
            }
        });
    }
   
</script>
</body>
</html>